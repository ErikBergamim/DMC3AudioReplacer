using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Threading;
using System.Windows.Media;

namespace WpfApp1
{
    public partial class MainWindow : Window
    {
        private string _lastJson;

        private string _rootFolder;
        private string _mapJsonPath;
        private List<JsonVagpMap.VagpItem> _items;
        private List<string> _filteredFiles;

        private MediaPlayer _player;
        private DispatcherTimer _playerTimer;
        private bool _sliderDragging;
        private string _tempPlayWav;

        private sealed class VagpRow
        {
            public string File { get; set; }
            public string Name { get; set; }
            public long Offset { get; set; }
            public long Length { get; set; }
            public int? SampleRate { get; set; }
        }

        public MainWindow()
        {
            InitializeComponent();

            string defaultFolder = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "GData.afs");
            if (Directory.Exists(defaultFolder))
                FolderTextBox.Text = defaultFolder;

            _mapJsonPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "gdata_vagp_map.json");
            LoadMapJsonIfPresent();
            UpdateUiForNoFileSelection();

            _player = new MediaPlayer();
            _player.MediaOpened += Player_MediaOpened;
            _player.MediaEnded += Player_MediaEnded;

            _playerTimer = new DispatcherTimer();
            _playerTimer.Interval = TimeSpan.FromMilliseconds(200);
            _playerTimer.Tick += PlayerTimer_Tick;
        }

        protected override void OnClosed(EventArgs e)
        {
            try
            {
                if (_playerTimer != null) _playerTimer.Stop();
                if (_player != null) _player.Close();
            }
            catch { }

            try { if (!string.IsNullOrEmpty(_tempPlayWav) && File.Exists(_tempPlayWav)) File.Delete(_tempPlayWav); } catch { }

            base.OnClosed(e);
        }

        private void Player_MediaOpened(object sender, EventArgs e)
        {
            PlayerPlayButton.IsEnabled = true;
            PlayerStopButton.IsEnabled = true;
            PlayerSlider.IsEnabled = true;

            UpdatePlayerUi();
            _playerTimer.Start();
        }

        private void Player_MediaEnded(object sender, EventArgs e)
        {
            _playerTimer.Stop();
            _player.Stop();
            PlayerSlider.Value = 0;
            UpdatePlayerUi();
        }

        private void PlayerTimer_Tick(object sender, EventArgs e)
        {
            if (_sliderDragging)
                return;
            UpdatePlayerUi();
        }

        private void UpdatePlayerUi()
        {
            TimeSpan pos = _player.Position;
            TimeSpan dur = (_player.NaturalDuration.HasTimeSpan) ? _player.NaturalDuration.TimeSpan : TimeSpan.Zero;

            double max = dur.TotalSeconds;
            if (max <= 0) max = 1;

            PlayerSlider.Maximum = max;
            PlayerSlider.Value = Math.Max(0, Math.Min(max, pos.TotalSeconds));

            PlayerTimeText.Text = FormatTime(pos) + " / " + FormatTime(dur);
        }

        private static string FormatTime(TimeSpan t)
        {
            if (t.TotalHours >= 1)
                return ((int)t.TotalHours).ToString("00") + ":" + t.Minutes.ToString("00") + ":" + t.Seconds.ToString("00");
            return t.Minutes.ToString("00") + ":" + t.Seconds.ToString("00");
        }

        private void PlayerPlayButton_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                _player.Play();
            }
            catch { }
        }

        private void PlayerStopButton_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                _player.Stop();
                PlayerSlider.Value = 0;
                UpdatePlayerUi();
            }
            catch { }
        }

        private void PlayerSlider_ValueChanged(object sender, RoutedPropertyChangedEventArgs<double> e)
        {
            if (!_sliderDragging)
                return;

            try
            {
                _player.Position = TimeSpan.FromSeconds(PlayerSlider.Value);
                UpdatePlayerUi();
            }
            catch { }
        }

        private void ScanButton_Click(object sender, RoutedEventArgs e)
        {
            string folder = (FolderTextBox.Text ?? string.Empty).Trim();
            if (folder.Length == 0)
            {
                MessageBox.Show("Please enter the GData.afs folder path.");
                return;
            }

            if (!Directory.Exists(folder))
            {
                MessageBox.Show("Folder not found: " + folder);
                return;
            }

            _rootFolder = folder;

            try { ClearReadOnlyRecursively(_rootFolder); } catch { }

            try
            {
                LoadMapJsonIfPresent();
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.ToString());
                StatusText.Text = "Error loading JSON.";
                return;
            }

            var files = _items.Select(i => i.File)
                .Where(f => !string.IsNullOrEmpty(f))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(s => s, StringComparer.OrdinalIgnoreCase)
                .ToList();

            _filteredFiles = files;
            FilesListBox.ItemsSource = files;
            VagpListView.ItemsSource = null;
            SelectedFileText.Text = "";

            StatusText.Text = "Map loaded.";
            CountsText.Text = "Files: " + files.Count + " | VAGp: " + _items.Count;
            HintText.Text = "Select a file on the left to see the VAGp from the JSON.";

            SaveButton.IsEnabled = File.Exists(_mapJsonPath);
        }

        private void SaveButton_Click(object sender, RoutedEventArgs e)
        {
            if (_lastJson == null)
                return;

            var dlg = new Microsoft.Win32.SaveFileDialog();
            dlg.Filter = "JSON (*.json)|*.json|All files (*.*)|*.*";
            dlg.FileName = "gdata_vagp_map.json";
            dlg.InitialDirectory = AppDomain.CurrentDomain.BaseDirectory;

            bool? ok = dlg.ShowDialog(this);
            if (ok == true)
            {
                File.WriteAllText(dlg.FileName, _lastJson, Encoding.UTF8);
                StatusText.Text = "JSON saved to: " + dlg.FileName;
            }
        }

        private void FileFilterTextBox_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_items == null)
                return;

            string filter = (FileFilterTextBox.Text ?? string.Empty).Trim();
            var all = _items.Select(i => i.File)
                .Where(f => !string.IsNullOrEmpty(f))
                .Distinct(StringComparer.OrdinalIgnoreCase);

            if (filter.Length != 0)
                all = all.Where(f => f.IndexOf(filter, StringComparison.OrdinalIgnoreCase) >= 0);

            _filteredFiles = all.OrderBy(s => s, StringComparer.OrdinalIgnoreCase).ToList();
            FilesListBox.ItemsSource = _filteredFiles;

            CountsText.Text = "Files: " + _filteredFiles.Count + " | VAGp: " + _items.Count;
        }

        private void FilesListBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            string file = FilesListBox.SelectedItem as string;
            if (string.IsNullOrEmpty(file) || _items == null)
            {
                VagpListView.ItemsSource = null;
                SelectedFileText.Text = "";
                return;
            }

            SelectedFileText.Text = "(" + file + ")";

            var rows = _items
                .Where(i => string.Equals(i.File, file, StringComparison.OrdinalIgnoreCase))
                .OrderBy(i => i.Offset)
                .Select(i => new VagpRow
                {
                    File = i.File,
                    Name = i.Name,
                    Offset = i.Offset,
                    Length = i.Length,
                    SampleRate = i.SampleRate
                })
                .ToList();

            VagpListView.ItemsSource = rows;
            HintText.Text = rows.Count > 0 ? ("VAGp in file: " + rows.Count) : "No VAGp for this file.";
        }

        private void ExportButton_Click(object sender, RoutedEventArgs e)
        {
            var row = (sender as Button)?.Tag as VagpRow;
            if (row == null) return;

            if (string.IsNullOrEmpty(_rootFolder))
            {
                MessageBox.Show("Please enter the GData.afs folder and click Load.");
                return;
            }

            string fullPath = Path.Combine(_rootFolder, row.File);
            if (!File.Exists(fullPath))
            {
                MessageBox.Show("File not found: " + fullPath);
                return;
            }

            var dlg = new Microsoft.Win32.SaveFileDialog();
            dlg.Filter = "BIN (*.bin)|*.bin|All files (*.*)|*.*";
            dlg.FileName = row.Name + "_" + (row.SampleRate.HasValue ? row.SampleRate.Value.ToString() : "nosr") + "_offset" + row.Offset + ".bin";
            dlg.InitialDirectory = _rootFolder;

            bool? ok = dlg.ShowDialog(this);
            if (ok != true) return;

            using (var fs = new FileStream(fullPath, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
            {
                fs.Position = row.Offset;
                CopyExactly(fs, dlg.FileName, row.Length);
            }

            StatusText.Text = "Exported: " + row.Name;
        }

        private void BulkExportButton_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrEmpty(_rootFolder))
            {
                MessageBox.Show("Please enter the GData.afs folder and click Load.");
                return;
            }

            string file = FilesListBox.SelectedItem as string;
            if (string.IsNullOrEmpty(file))
            {
                MessageBox.Show("Please select a file from the list on the left.");
                return;
            }

            string targetPac = Path.Combine(_rootFolder, file);
            if (!File.Exists(targetPac))
            {
                MessageBox.Show("File not found: " + targetPac);
                return;
            }

            string exeDir = AppDomain.CurrentDomain.BaseDirectory;
            string mfaudioPath = Path.Combine(exeDir, "mfaudio.exe");
            if (!File.Exists(mfaudioPath))
            {
                MessageBox.Show("mfaudio.exe not found in program folder: " + mfaudioPath);
                return;
            }

            string outDir = PickFolder("Select folder to export WAV files");
            if (outDir == null)
                return;

            var entries = _items
                .Where(i => string.Equals(i.File, file, StringComparison.OrdinalIgnoreCase))
                .OrderBy(i => i.Offset)
                .ToList();

            int done = 0;
            foreach (var it in entries)
            {
                if (!it.SampleRate.HasValue)
                    continue;

                string tempVag = Path.Combine(Path.GetTempPath(), "vagp_" + Guid.NewGuid().ToString("N") + ".vag");
                string tempWav = Path.Combine(Path.GetTempPath(), "vagp_" + Guid.NewGuid().ToString("N") + ".wav");

                try
                {
                    using (var fs = new FileStream(targetPac, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                    {
                        fs.Position = it.Offset;
                        CopyExactly(fs, tempVag, it.Length);
                    }

                    TryPatchVagSampleRateBigEndian(tempVag, it.SampleRate.Value);
                    RunMfaudioToWav(mfaudioPath, it.SampleRate.Value, tempVag, tempWav);

                    string outPath = Path.Combine(outDir, it.Name + ".wav");
                    File.Copy(tempWav, outPath, true);
                    done++;
                }
                finally
                {
                    try { if (File.Exists(tempVag)) File.Delete(tempVag); } catch { }
                    try { if (File.Exists(tempWav)) File.Delete(tempWav); } catch { }
                }
            }

            StatusText.Text = "Exported: " + done + " WAV file(s)";
        }

        private void BulkReplaceButton_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrEmpty(_rootFolder))
            {
                MessageBox.Show("Please enter the GData.afs folder and click Load.");
                return;
            }

            string file = FilesListBox.SelectedItem as string;
            if (string.IsNullOrEmpty(file))
            {
                MessageBox.Show("Please select a file from the list on the left.");
                return;
            }

            string targetPac = Path.Combine(_rootFolder, file);
            if (!File.Exists(targetPac))
            {
                MessageBox.Show("File not found: " + targetPac);
                return;
            }

            string exeDir = AppDomain.CurrentDomain.BaseDirectory;
            string mfaudioPath = Path.Combine(exeDir, "mfaudio.exe");
            if (!File.Exists(mfaudioPath))
            {
                MessageBox.Show("mfaudio.exe not found in program folder: " + mfaudioPath);
                return;
            }

            string wavDir = PickFolder("Select folder containing WAVs (VAGp1.wav, VAGp2.wav, ...)");
            if (wavDir == null)
                return;

            try { MakeWritable(targetPac); } catch { }

            string backupPath = targetPac + ".bak";
            if (!File.Exists(backupPath))
            {
                File.Copy(targetPac, backupPath, false);
                try { MakeWritable(backupPath); } catch { }
            }

            var entries = _items
                .Where(i => string.Equals(i.File, file, StringComparison.OrdinalIgnoreCase))
                .OrderBy(i => i.Offset)
                .ToList();

            int patched = 0;
            foreach (var it in entries)
            {
                string wavPath = Path.Combine(wavDir, it.Name + ".wav");
                if (!File.Exists(wavPath))
                    continue;
                if (!it.SampleRate.HasValue)
                    continue;

                string tempRaw = Path.Combine(Path.GetTempPath(), "mfaudio_" + Guid.NewGuid().ToString("N") + ".raw");
                try
                {
                    RunMfaudio(mfaudioPath, it.SampleRate.Value, wavPath, tempRaw);
                    byte[] replacement = File.ReadAllBytes(tempRaw);
                    int toWrite = replacement.Length > it.Length ? (int)it.Length : replacement.Length;

                    using (var fs = new FileStream(targetPac, FileMode.Open, FileAccess.ReadWrite, FileShare.ReadWrite))
                    {
                        fs.Position = it.Offset;
                        fs.Write(replacement, 0, toWrite);
                    }

                    patched++;
                }
                finally
                {
                    try { if (File.Exists(tempRaw)) File.Delete(tempRaw); } catch { }
                }
            }

            StatusText.Text = "Replaced: " + patched + " VAGp";
        }

        private void EnhanceQualityButton_Click(object sender, RoutedEventArgs e)
        {
            var row = (sender as Button)?.Tag as VagpRow;
            if (row == null) return;

            if (string.IsNullOrEmpty(_rootFolder))
            {
                MessageBox.Show("Please enter the GData.afs folder and click Load.");
                return;
            }

            string fullPath = Path.Combine(_rootFolder, row.File);
            if (!File.Exists(fullPath))
            {
                MessageBox.Show("File not found: " + fullPath);
                return;
            }

            int vagpNumber = ExtractVagpNumber(row.Name);
            if (vagpNumber < 0)
            {
                MessageBox.Show("Could not extract VAGp number from name: " + row.Name);
                return;
            }

            string input = PromptForInput("Enter quality multiplier (e.g. 4 for 4x):", "Enhance Quality", "4");

            if (string.IsNullOrEmpty(input) || input.Trim().Length == 0)
                return;

            int multiplier;
            if (!int.TryParse(input, out multiplier) || multiplier <= 0)
            {
                MessageBox.Show("Please enter a valid number greater than zero.");
                return;
            }

            try
            {
                MakeWritable(fullPath);

                string backupPath = fullPath + ".bak";
                if (!File.Exists(backupPath))
                {
                    File.Copy(fullPath, backupPath, false);
                    try { MakeWritable(backupPath); } catch { }
                }

                bool success = EnhanceVagpQualityInPac(fullPath, vagpNumber, multiplier);

                if (success)
                {
                    StatusText.Text = string.Format("Quality enhanced {0}x for: {1}", multiplier, row.Name);
                    MessageBox.Show(string.Format("Quality enhanced successfully!\n\nVAGp: {0}\nMultiplier: {1}x\n\nNOTE: The VAGI table has been updated.\nOffsets of all following VAGp have been adjusted.\nNow you need to replace the VAGp with a higher quality file using the 'Replace...' button.", row.Name, multiplier));
                }
                else
                {
                    StatusText.Text = "Failed to enhance quality.";
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error enhancing quality:\n\n" + ex.ToString());
                StatusText.Text = "Error enhancing quality.";
            }
        }

        private string PromptForInput(string message, string title, string defaultValue)
        {
            Window inputDialog = new Window
            {
                Title = title,
                Width = 400,
                Height = 180,
                WindowStartupLocation = WindowStartupLocation.CenterOwner,
                Owner = this,
                ResizeMode = ResizeMode.NoResize
            };

            Grid grid = new Grid();
            grid.Margin = new Thickness(15);
            grid.RowDefinitions.Add(new RowDefinition { Height = new GridLength(1, GridUnitType.Auto) });
            grid.RowDefinitions.Add(new RowDefinition { Height = new GridLength(15) });
            grid.RowDefinitions.Add(new RowDefinition { Height = new GridLength(1, GridUnitType.Auto) });
            grid.RowDefinitions.Add(new RowDefinition { Height = new GridLength(15) });
            grid.RowDefinitions.Add(new RowDefinition { Height = new GridLength(1, GridUnitType.Auto) });

            TextBlock messageBlock = new TextBlock { Text = message, TextWrapping = TextWrapping.Wrap };
            Grid.SetRow(messageBlock, 0);
            grid.Children.Add(messageBlock);

            TextBox inputBox = new TextBox { Text = defaultValue, Height = 30 };
            Grid.SetRow(inputBox, 2);
            grid.Children.Add(inputBox);

            StackPanel buttonPanel = new StackPanel { Orientation = Orientation.Horizontal, HorizontalAlignment = HorizontalAlignment.Right };
            Grid.SetRow(buttonPanel, 4);

            Button okButton = new Button { Content = "OK", Width = 80, Height = 30, Margin = new Thickness(0, 0, 10, 0), IsDefault = true };
            Button cancelButton = new Button { Content = "Cancel", Width = 80, Height = 30, IsCancel = true };

            string result = null;
            okButton.Click += (s, e) => { result = inputBox.Text; inputDialog.DialogResult = true; inputDialog.Close(); };
            cancelButton.Click += (s, e) => { inputDialog.DialogResult = false; inputDialog.Close(); };

            buttonPanel.Children.Add(okButton);
            buttonPanel.Children.Add(cancelButton);
            grid.Children.Add(buttonPanel);

            inputDialog.Content = grid;
            inputDialog.ShowDialog();

            return result;
        }

        private bool EnhanceVagpQualityInPac(string pacPath, int vagpNumber, int multiplier)
        {
            byte[] fileData = File.ReadAllBytes(pacPath);

            long vagiOffset = FindVagiSignature(fileData);
            if (vagiOffset < 0)
            {
                MessageBox.Show("VAGI signature not found in PAC file.");
                return false;
            }

            List<VagiEntry> vagiEntries = ParseVagiEntries(fileData, vagiOffset);

            int targetIndex = vagpNumber - 1;

            if (targetIndex < 0 || targetIndex >= vagiEntries.Count)
            {
                MessageBox.Show(string.Format("VAGp{0} not found in VAGI table.\nTotal entries: {1}", vagpNumber, vagiEntries.Count));
                return false;
            }

            long originalOffset = vagiEntries[targetIndex].StartOffset;
            long originalLength = vagiEntries[targetIndex].Length;
            
            byte[] originalVagpData = new byte[originalLength];
            Array.Copy(fileData, originalOffset, originalVagpData, 0, originalLength);

            long newLength = originalLength * multiplier;
            byte[] expandedData = new byte[newLength];
            
            for (int i = 0; i < multiplier; i++)
            {
                Array.Copy(originalVagpData, 0, expandedData, i * originalLength, originalLength);
            }

            long lengthDelta = newLength - originalLength;

            byte[] newFileData = ExpandFileData(fileData, originalOffset, originalLength, expandedData);

            vagiEntries[targetIndex].Length = newLength;

            for (int i = targetIndex + 1; i < vagiEntries.Count; i++)
            {
                vagiEntries[i].StartOffset += lengthDelta;
            }

            WriteVagiEntries(newFileData, vagiOffset, vagiEntries);

            File.WriteAllBytes(pacPath, newFileData);

            UpdateJsonWithNewOffsets(pacPath, vagiEntries);

            return true;
        }

        private void UpdateJsonWithNewOffsets(string pacPath, List<VagiEntry> vagiEntries)
        {
            try
            {
                if (_items == null || _items.Count == 0)
                    return;

                string pacFileName = Path.GetFileName(pacPath);

                var itemsToUpdate = _items.Where(item => 
                    string.Equals(item.File, pacFileName, StringComparison.OrdinalIgnoreCase))
                    .ToList();

                if (itemsToUpdate.Count == 0)
                    return;

                for (int i = 0; i < itemsToUpdate.Count && i < vagiEntries.Count; i++)
                {
                    itemsToUpdate[i].Offset = vagiEntries[i].StartOffset;
                    itemsToUpdate[i].Length = vagiEntries[i].Length;
                }

                string json = JsonVagpMap.Save(_items);
                File.WriteAllText(_mapJsonPath, json, Encoding.UTF8);
                _lastJson = json;

                StatusText.Text = "JSON updated with new offsets and lengths.";
            }
            catch (Exception ex)
            {
                StatusText.Text = "Warning: Failed to update JSON: " + ex.Message;
            }
        }

        private void LoadMapJsonIfPresent()
        {
            if (!File.Exists(_mapJsonPath))
            {
                StatusText.Text = "JSON map not found: " + _mapJsonPath;
                _items = new List<JsonVagpMap.VagpItem>();
                _lastJson = null;
                return;
            }

            _items = JsonVagpMap.Load(_mapJsonPath);
            _lastJson = File.ReadAllText(_mapJsonPath, Encoding.UTF8);
            StatusText.Text = "Map loaded: " + Path.GetFileName(_mapJsonPath);
        }

        private void UpdateUiForNoFileSelection()
        {
            FilesListBox.ItemsSource = null;
            VagpListView.ItemsSource = null;
            SelectedFileText.Text = "";
            HintText.Text = "Enter the GData.afs folder and click Load.";
            CountsText.Text = "";
            SaveButton.IsEnabled = File.Exists(_mapJsonPath);

            PlayerPlayButton.IsEnabled = false;
            PlayerStopButton.IsEnabled = false;
            PlayerSlider.IsEnabled = false;
            PlayerSlider.Value = 0;
            PlayerTimeText.Text = "00:00 / 00:00";
        }

        private static void ClearReadOnlyRecursively(string rootFolder)
        {
            foreach (string file in Directory.GetFiles(rootFolder, "*", SearchOption.AllDirectories))
            {
                MakeWritable(file);
            }
        }

        private static void MakeWritable(string filePath)
        {
            FileAttributes attrs = File.GetAttributes(filePath);
            if ((attrs & FileAttributes.ReadOnly) != 0)
            {
                attrs = attrs & ~FileAttributes.ReadOnly;
                File.SetAttributes(filePath, attrs);
            }
        }

        private static void CopyExactly(FileStream input, string outputPath, long length)
        {
            const int bufferSize = 64 * 1024;
            byte[] buffer = new byte[bufferSize];

            using (var outFs = new FileStream(outputPath, FileMode.Create, FileAccess.Write, FileShare.None))
            {
                long remaining = length;
                while (remaining > 0)
                {
                    int toRead = remaining > buffer.Length ? buffer.Length : (int)remaining;
                    int read = input.Read(buffer, 0, toRead);
                    if (read <= 0) throw new EndOfStreamException();
                    outFs.Write(buffer, 0, read);
                    remaining -= read;
                }
            }
        }

        private static void RunMfaudio(string mfaudioPath, int sampleRate, string wavPath, string rawOutPath)
        {
            string args = "/OTVAGC /OC1 /OF" + sampleRate + " \"" + wavPath + "\" \"" + rawOutPath + "\"";

            var psi = new ProcessStartInfo();
            psi.FileName = mfaudioPath;
            psi.Arguments = args;
            psi.WorkingDirectory = Path.GetDirectoryName(mfaudioPath);
            psi.CreateNoWindow = true;
            psi.UseShellExecute = false;
            psi.RedirectStandardOutput = true;
            psi.RedirectStandardError = true;

            using (var p = Process.Start(psi))
            {
                string stdout = p.StandardOutput.ReadToEnd();
                string stderr = p.StandardError.ReadToEnd();
                p.WaitForExit();
                if (p.ExitCode != 0)
                    throw new InvalidOperationException("mfaudio.exe failed (ExitCode=" + p.ExitCode + ").\n\nSTDOUT:\n" + stdout + "\n\nSTDERR:\n" + stderr);
            }
        }

        private static void RunMfaudioToWav(string mfaudioPath, int sampleRate, string vagPath, string wavOutPath)
        {
            string args = "/OTWAVU /OF" + sampleRate + " \"" + vagPath + "\" \"" + wavOutPath + "\"";

            var psi = new ProcessStartInfo();
            psi.FileName = mfaudioPath;
            psi.Arguments = args;
            psi.WorkingDirectory = Path.GetDirectoryName(mfaudioPath);
            psi.CreateNoWindow = true;
            psi.UseShellExecute = false;
            psi.RedirectStandardOutput = true;
            psi.RedirectStandardError = true;

            using (var p = Process.Start(psi))
            {
                string stdout = p.StandardOutput.ReadToEnd();
                string stderr = p.StandardError.ReadToEnd();
                p.WaitForExit();

                if (p.ExitCode != 0)
                    throw new InvalidOperationException("mfaudio.exe failed (ExitCode=" + p.ExitCode + ").\n\nSTDOUT:\n" + stdout + "\n\nSTDERR:\n" + stderr);
            }
        }

        private void PlaySoundButton_Click(object sender, RoutedEventArgs e)
        {
            var row = (sender as Button)?.Tag as VagpRow;
            if (row == null) return;

            if (string.IsNullOrEmpty(_rootFolder))
            {
                MessageBox.Show("Please enter the GData.afs folder and click Load.");
                return;
            }

            if (!row.SampleRate.HasValue)
            {
                MessageBox.Show("SampleRate not found in JSON for this VAGp.");
                return;
            }

            string fullPath = Path.Combine(_rootFolder, row.File);
            if (!File.Exists(fullPath))
            {
                MessageBox.Show("File not found: " + fullPath);
                return;
            }

            string exeDir = AppDomain.CurrentDomain.BaseDirectory;
            string mfaudioPath = Path.Combine(exeDir, "mfaudio.exe");
            if (!File.Exists(mfaudioPath))
            {
                MessageBox.Show("mfaudio.exe not found in program folder: " + mfaudioPath);
                return;
            }

            string tempVag = Path.Combine(Path.GetTempPath(), "vagp_" + Guid.NewGuid().ToString("N") + ".vag");
            string tempWav = Path.Combine(Path.GetTempPath(), "vagp_" + Guid.NewGuid().ToString("N") + ".wav");

            try
            {
                using (var fs = new FileStream(fullPath, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                {
                    fs.Position = row.Offset;
                    CopyExactly(fs, tempVag, row.Length);
                }

                TryPatchVagSampleRateBigEndian(tempVag, row.SampleRate.Value);
                RunMfaudioToWav(mfaudioPath, row.SampleRate.Value, tempVag, tempWav);

                if (!File.Exists(tempWav))
                    throw new FileNotFoundException("Temporary WAV was not generated.", tempWav);

                try { if (!string.IsNullOrEmpty(_tempPlayWav) && File.Exists(_tempPlayWav)) File.Delete(_tempPlayWav); } catch { }
                _tempPlayWav = tempWav;

                _playerTimer.Stop();
                _player.Stop();
                _player.Close();

                _player.Open(new Uri(tempWav, UriKind.Absolute));

                StatusText.Text = "Ready to play: " + row.Name;
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.ToString());
                try { if (!string.IsNullOrEmpty(tempWav) && File.Exists(tempWav)) File.Delete(tempWav); } catch { }
            }
            finally
            {
                try { if (File.Exists(tempVag)) File.Delete(tempVag); } catch { }
            }
        }

        private static void TryPatchVagSampleRateBigEndian(string vagPath, int sampleRate)
        {
            // Writes big-endian sample rate at offset 0x12 from the beginning of the VAG data.
            // Expected header begins with: 56 41 47 70 00 00 ("VAGp\0\0").
            const int sampleRateOffset = 0x12;

            if (!File.Exists(vagPath))
                return;

            using (var fs = new FileStream(vagPath, FileMode.Open, FileAccess.ReadWrite, FileShare.Read))
            {
                if (fs.Length < sampleRateOffset + 2)
                    return;

                // Verify magic
                fs.Position = 0;
                int b0 = fs.ReadByte();
                int b1 = fs.ReadByte();
                int b2 = fs.ReadByte();
                int b3 = fs.ReadByte();
                if (b0 != 0x56 || b1 != 0x41 || b2 != 0x47 || b3 != 0x70)
                    return;

                fs.Position = sampleRateOffset;
                fs.WriteByte((byte)((sampleRate >> 8) & 0xFF));
                fs.WriteByte((byte)(sampleRate & 0xFF));
            }
        }

        private void LoadMapJsonIfPresent()
        {
            if (!File.Exists(_mapJsonPath))
            {
                StatusText.Text = "JSON map not found: " + _mapJsonPath;
                _items = new List<JsonVagpMap.VagpItem>();
                _lastJson = null;
                return;
            }

            _items = JsonVagpMap.Load(_mapJsonPath);
            _lastJson = File.ReadAllText(_mapJsonPath, Encoding.UTF8);
            StatusText.Text = "Map loaded: " + Path.GetFileName(_mapJsonPath);
        }

        private void UpdateUiForNoFileSelection()
        {
            FilesListBox.ItemsSource = null;
            VagpListView.ItemsSource = null;
            SelectedFileText.Text = "";
            HintText.Text = "Enter the GData.afs folder and click Load.";
            CountsText.Text = "";
            SaveButton.IsEnabled = File.Exists(_mapJsonPath);

            PlayerPlayButton.IsEnabled = false;
            PlayerStopButton.IsEnabled = false;
            PlayerSlider.IsEnabled = false;
            PlayerSlider.Value = 0;
            PlayerTimeText.Text = "00:00 / 00:00";
        }
    }
}
